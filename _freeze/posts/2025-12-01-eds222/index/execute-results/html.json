{
  "hash": "25c220fcd4a0d2efa963240fa55be018",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"EDS 222: Herbarium Specimen Phenology\"\ndescription: \"A statistical analysis of shifts in leaf color timing\"\ndate: 2025-12-11\ncategories: [MEDS, R]\nimage: acer.png\ncitation:\n  url: https://avarobillard.github.io/posts/2025-12-01-eds222\nbibliography: references.bib\ndraft: false\n#draft-mode: linked\n---\n\n## Question and data\n\nMany studies have found climate-related delays in the timing of leaf coloration, but do not have a lot of data from before the late 20th century [@garreston].\n\nA data set collected by Garretson and Forkner in 2021 from the Southeast Regional Network of Expertise and Collections [@SRNEC] contains evaluations of 2,972 digitized herbaria specimens of red and sugar maples collected between 1826 and 2016. They paired these specimens with climate and locality information to investigate long-term trends in autumn phenology over the past century [@edi713].\n\nUsing this data, I want to analyze the effects of day of year (doy), year, and mean fall temperature on the presence of colored leaves as well as determine whether the day of the year when there becomes a higher probability of leaf color is shifting earlier over time.\n\n::: figure\n![DAG](DAG.png){width=\"60%\"}\n:::\n\nI think that year, day of the year, and mean fall temperature all have an effect on whether a leaf is colored. Day of year is a seasonal relationship, where leaf coloration is expected the least in the summer (\\~180-250 doy) and more after that period in the fall (\\~250-300 doy). Cooler fall temperatures could cause a quicker onset of leaf coloration and senescence, while warmer mean temperatures could delay it. Year could affect leaf coloration through long-term trends in climate, and could also directly affect mean fall temperatures, as some years are generally warmer or cooler than others.\n\n### Load packages and data\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(here)\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(segmented)\nlibrary(kableExtra)\nlibrary(broom)\nlibrary(gtsummary)\nlibrary(modelsummary)\n\n# Read in data\nautumn_data <- read_csv(here::here(\"posts\", \"2025-12-01-eds222\", \"data\", \"autumn_data.csv\")) %>% \n  clean_names() \n```\n:::\n\n\n### 1. Explore data\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(autumn_data, aes(x = longitude, y = latitude)) +\n  geom_point(color = \"darkgreen\") +\n  labs(x = \"Longitude\", y = \"Latitude\", \n       title = \"Herbarium Specimen Locations\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![Figure 1: Initial exploration of the spatial distribution of Herbarium specimens.](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nThe specimens are located relatively uniformly throughout the Northeast.\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create scatter plot\nggplot(autumn_data, aes(x = doy, y = colored_leaves, color = species)) +\n  geom_jitter(alpha = 0.5, width = 0, height = 0.1) +\n  scale_color_manual(values = c(\"#6F8FAF\", \"#8A9A5B\")) +\n  labs(x = \"Day of Year\",\n       y = \"Colored Leaves\") +\n  theme_minimal() \n```\n\n::: {.cell-output-display}\n![Figure 2: Initial exploration of the effects of day of the year on the presence of colored leaves (0/1).](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nThe binary colored_leaves variable appears to have many more specimens with non-colored leaves, which are spread throughout the entire year but show a cluster between about doy 80 and 300. There are fewer specimens with colored leaves, with a more concentrated spread between doy 100 and 320. This data distribution suggests that a logistic regression model could be a good fit.  \n\nA better way to visualize the colored_leaves variable and potentially see a seasonal trend is to group our observations into 2-week bins and calculate the proportion of colored leaves within each bin. \n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create 14-day bins\nautumn_binned <- autumn_data %>%\n  mutate(doy_bin = cut(doy, breaks = seq(0, 366, by = 14), include.lowest = TRUE, right = FALSE)) %>%\n  group_by(doy_bin) %>%\n  summarize(n = n(),  # total number within each bin\n            prop_colored = mean(colored_leaves), # calculate proportion within each bin\n            doy_mid = mean(doy) # find mean doy of each bin for labeling\n  )\n\n# Create line plot\nggplot(autumn_binned, aes(x = doy_mid, y = prop_colored)) +\n  geom_line(color = \"#C41E3A\", size = 1) +\n  geom_point(color = \"#C41E3A\", size = 2) +\n  labs(x = \"Day of Year\",\n       y = \"Proportion with Colored Leaves\",\n       title = \"Proportion of Colored Leaves by Day of Year (2-week bins)\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![Figure 3: Visualization of proportion of colored leaves in each 2-week period of the year.](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\nThere seems to be an increase in the proportion of colored leaves from approximately day 100 to a peak at day 300, before falling back to 0 around day 340. This reflects a seasonal trend, where leaves are increasingly more likely to be colored as fall approaches and peaks around day 300, and then fall from the trees for winter and return the proportion of colored leaves back to 0.\n\nLastly, I want to visualize how many observations generally lie in each year.\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Filter data to a few years to visualize this over time\nautumn_data_decades <- autumn_data %>% \n  filter(year %in% c(1900, 1910, 1920, 1930, 1940, 1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020))\n\n# Create scatter plot\nggplot(autumn_data_decades, aes(x = doy, y = colored_leaves, color = year)) +\n  geom_jitter(alpha = 0.6, width = 0, height = 0.1) +\n  scale_color_gradientn(colors = c(\"#FFBF00\", \"orange\",\"#CC5500\", \"#C41E3A\", \"#660033\"), guide = \"none\") +\n  labs(x = \"Day of Year\",\n       y = \"Colored Leaves\") +\n  facet_wrap(~year) +\n  theme_minimal() \n```\n\n::: {.cell-output-display}\n![Figure 4: Exploration of the effects of day of the year on the presence of colored leaves (0/1), separated by year.](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\nThis plot shows that there are relatively few colored leaf data points in each year of observation, which might create a challenge when trying to draw conclusions. \n\n### 2. Fit model\n\nAfter exploring the data, I want to fit a logistic model with day of year, year, and mean fall temperature as predictors and colored leaves as a binary response.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Logistic model\nbin_model <- glm(colored_leaves ~ doy + year + mean_fall,\n                 data = autumn_data,\n                 family = binomial(link = \"logit\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create coefficient table\ntidy(bin_model) %>%\n  kable(digits = 3, caption = \"Coefficient Estimates for Logistic Model\") %>% \n  kable_styling(bootstrap_options = \"striped\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Coefficient Estimates for Logistic Model</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 1.348 </td>\n   <td style=\"text-align:right;\"> 3.469 </td>\n   <td style=\"text-align:right;\"> 0.389 </td>\n   <td style=\"text-align:right;\"> 0.697 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> doy </td>\n   <td style=\"text-align:right;\"> 0.013 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 14.664 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> year </td>\n   <td style=\"text-align:right;\"> -0.003 </td>\n   <td style=\"text-align:right;\"> 0.002 </td>\n   <td style=\"text-align:right;\"> -1.745 </td>\n   <td style=\"text-align:right;\"> 0.081 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean_fall </td>\n   <td style=\"text-align:right;\"> 0.029 </td>\n   <td style=\"text-align:right;\"> 0.028 </td>\n   <td style=\"text-align:right;\"> 1.054 </td>\n   <td style=\"text-align:right;\"> 0.292 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nOnly the day of year (doy) variable is significant, with a p-value below 0.05. The positive coefficient for doy indicates that the probability of colored leaves increases later in the year, consistent with the seasonal pattern in our data exploration. Because the other predictors were not statistically significant and there is a relatively high possibility of getting these values by chance, we cannot infer that mean fall temperature and year have a meaningful effect on the probability of colored leaves.\n\n### 3. Explore logistic curves over time\n\nNext, I want to look at the model fit over a selection of years to better visualize whether doy where probability of colored leaves shifts from 0 to 1 becomes earlier over time. Setting mean_fall to the average allows us to focus on the relationship between day of year and year on leaf coloration.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Pick four years to model\nyears <- c(1900, 1940, 1980, 2020)\n\n# Make data frame of predictors using means for fixed variables\npred_grid <- expand_grid(\n  doy = 1:365,\n  year = years,\n) %>% \n  mutate(\n    mean_fall = mean(autumn_data$mean_fall, na.rm = TRUE)\n  )\n\n# Generate predictions using model- just best estimate\nbin_model_pred <- pred_grid %>% \n  mutate(p = predict(object = bin_model,\n                     newdata = pred_grid,\n                     type = \"response\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Plot predictions for three years \nggplot(bin_model_pred, aes(x = doy, y = p, color = factor(year))) +\n  geom_line() +\n  coord_cartesian(ylim = c(0,1)) +\n  scale_color_manual(values = c(\"1900\" = \"#FFBF00\", \"1940\" = \"#CC5500\", \"1980\" = \"#C41E3A\", \n                                \"2020\" = \"#660033\")) +\n  labs(color = \"Year\", y = \"p\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nWe can also transition between link and response space to visualize this plot with confidence intervals.\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create confidence interval\nbin_model_se <- predict(object = bin_model,\n                          newdata = pred_grid,\n                          type = \"link\", # stay in link space!\n                          se.fit = TRUE) # get the se of the fit\n\n# Go from link space to response space\nlinkinv <- family(bin_model)$linkinv\n\nbin_model_pred_l <- pred_grid %>% \n  mutate(\n    # get logit(p)\n    logit_p = bin_model_se$fit,\n    # 95% CI in link space- keeps in realistic range of values!! can do math here\n    logit_p_se = bin_model_se$se.fit,\n    logit_p_lwr = qnorm(0.025, mean = logit_p, sd = logit_p_se),\n    logit_p_upr = qnorm(0.975, mean = logit_p, sd = logit_p_se),\n    # undo the link function using linkinv- can interpret here\n    p = linkinv(logit_p),\n    p_lwr = linkinv(logit_p_lwr),\n    p_upr = linkinv(logit_p_upr)\n  )\n\n# filter predictions to a few years\nbin_model_pred_l_filtered <- bin_model_pred_l %>%\n  filter(year %in% c(1900, 1940, 1980, 2020)) %>%\n  mutate(year = factor(year))\n\n# plot \nggplot(bin_model_pred_l_filtered, aes(x = doy, y = p, fill = year))+\n  geom_ribbon(aes(ymin = p_lwr, ymax = p_upr), alpha = 0.2) +\n  scale_fill_manual(values = c(\"1900\" = \"#FFBF00\", \"1940\" = \"#CC5500\", \"1980\" = \"#C41E3A\", \n                                \"2020\" = \"#660033\")) +\n  geom_line() +\n  coord_cartesian(ylim = c(0,1)) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nBased on this figure, the day of year where leaf coloration probability is 0.5 is shifting to the right from 1900 to 2020, or becoming later in the year over time.\n\nTo see if my results will change due to seasonality and when colored leaves are most probable, I want to make mid-summer associated with 0 as this is when there is most likely to be 0 colored leaves, and shift the other days of the year accordingly. I also want to group the data by decade to create more data points for plotting, to correct for the issues seen in Figure 3 of my data exploration.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Mutate data \nautumn_data_decadegroups <- autumn_data %>% \n  mutate(doy_summer = (doy - 180) %% 365,\n         decade = floor(year/10) * 10) \n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit model based on mutated data\nbin_model_summer <- glm(colored_leaves ~ doy_summer + decade + mean_fall,\n                 data = autumn_data_decadegroups,\n                 family = binomial(link = \"logit\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create coefficient table\ntidy(bin_model_summer) %>%\n  kable(digits = 3, caption = \"Coefficient Estimates for Logistic Decade Model\") %>% \n  kable_styling(bootstrap_options = \"striped\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Coefficient Estimates for Logistic Decade Model</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 2.704 </td>\n   <td style=\"text-align:right;\"> 3.266 </td>\n   <td style=\"text-align:right;\"> 0.828 </td>\n   <td style=\"text-align:right;\"> 0.408 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> doy_summer </td>\n   <td style=\"text-align:right;\"> -0.003 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> -6.915 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> decade </td>\n   <td style=\"text-align:right;\"> -0.002 </td>\n   <td style=\"text-align:right;\"> 0.002 </td>\n   <td style=\"text-align:right;\"> -1.280 </td>\n   <td style=\"text-align:right;\"> 0.201 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean_fall </td>\n   <td style=\"text-align:right;\"> 0.021 </td>\n   <td style=\"text-align:right;\"> 0.026 </td>\n   <td style=\"text-align:right;\"> 0.811 </td>\n   <td style=\"text-align:right;\"> 0.417 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nOnly day of year continued to be statistically significant, but in contrast to the previous model is negative. Let's see what this looks like plotted!\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Pick four decades to model\ndecades <- c(1900, 1940, 1980, 2010)\n\n# Make data frame of predictors using means for fixed variables\npred_grid2 <- expand_grid(\n  doy_summer = 1:365,\n  decade = decades,\n) %>% \n  mutate(\n    mean_fall = mean(autumn_data_decadegroups$mean_fall, na.rm = TRUE)\n  )\n\n# Generate predictions using model- just best estimate\nbin_model_pred2 <- pred_grid2 %>% \n  mutate(p = predict(object = bin_model_summer,\n                     newdata = pred_grid2,\n                     type = \"response\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Plot predictions for four decades\nggplot(bin_model_pred2, aes(x = doy_summer, y = p, color = factor(decade))) +\n  geom_line() +\n  coord_cartesian(ylim = c(0,1)) +\n  labs(color = \"Decade\", y = \"p\") +\n  scale_color_manual(values = c(\"1900\" = \"#FFBF00\", \"1940\" = \"#CC5500\", \"1980\" = \"#C41E3A\", \n                                \"2020\" = \"#660033\")) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nThis plot shows a negative trend in leave coloration probability over time with a starting point of mid summer, which is unexpected given our hypothesis. The coefficient for doy_summer was slightly negative and significant, indicating that for each day after mid-summer the probability of colored leaves decreased, as shown in our plot. This might be due to a lack of data in later summer and early fall days, or collection biases where trees that showed earlier color were collected because they were more noticeable. \n\n### 4. Statistical model and simulation\n\nNext, I want to apply a slightly more complex segmented model to my data. We can use a simplified model to simulate data from and better understand how a segmented model works:\n\n$$\n\\text{BinaryOutcome} \\sim \\text{Binomial}(1, p)\n$$\n$$\n\\text{logit}(p) =\n\\beta_0 + \\beta_1 \\cdot \\text{x} + \\beta_2 \\cdot \\text{x} \\cdot \\text{afterbreakpoint}\n$$\nWhere afterbreakpoint is a binary variable where 0 corresponds to before the determined breakpoint and 1 is after. This allows us to have the different slopes depending upon where we are along the x-axis. This difference in slopes is beta 2.\n\nWe will use these steps:\n\n1.  Choose a set of parameters and predictor variable(s) for the simulation\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nset.seed(123)\n\n# 1. Choose a set of parameters \nbeta0 <- 0\nbeta1 <- 0.4\nbeta2 <- 0.5\n\n# Create x values\nx_before <- seq(0, 20, length.out = 1000)\n\n# Want breakpoint to be the middle @ x = 10\n# Subtract 10 from every x value\nx <- x_before - 10\n\n# Create breakpoint indicator- now @ x = 0 \n# make this 0 if x is negative and 1 if x is positive\nafterbreakpoint <- case_when(\n  x < 0 ~ 0,\n  x >= 0 ~ 1\n)\n```\n:::\n\n\n2.  Use a random variable to generate a response, based on the parameters and predictor(s)\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Write out formula based on model notation\nlogit_p <- beta0 + beta1*x + beta2*(x*afterbreakpoint)\n\np <- exp(logit_p) / (1 + exp(logit_p))\n\n# 2. Use a random variable to generate Binary outcomes\ny <- rbinom(n = length(p), size = 1, prob = p)\n\n# Create full simulated data\nsim_dat <- tibble(x, afterbreakpoint, y) \n```\n:::\n\n\n3.  Fit a model to the simulated data\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# 3. Fit model to simulated data\nsim_mod <- glm(y ~ x + x:afterbreakpoint,\n                 data = sim_dat,\n                 family = binomial(link = \"logit\"))\n\n# Fit logistic model with x values before subtracting 10\nsim_mod_before <- glm(y ~ x_before, data = sim_dat,\n                    family = binomial)\n\n# Fit segmented model \nseg_mod <- segmented(sim_mod_before, seg.Z = ~ x_before)\n```\n:::\n\n\n4.  Check if the model's parameter estimates match selected parameters\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# 4. Check if model's parameters match \nmod_summ <- summary(sim_mod)\nbeta_0_hat <- coef(sim_mod)[1]\nbeta_1_hat <- coef(sim_mod)[2]\nbeta_2_hat <- coef(sim_mod)[3]\nbreakpoint_est <- summary(seg_mod)$psi[1, \"Est.\"]\n\n# Create kable table with values for comparison\ncomparison_table <- rbind(\n  Selected = round(c(beta0, beta1, beta2, 10), 2),\n  Model = round(c(beta_0_hat, beta_1_hat, beta_2_hat, breakpoint_est), 2))\n\ncolnames(comparison_table) <- c(\"Beta 0\", \"Beta 1\", \"Beta 2\", \"Breakpoint\")\n\nkable(comparison_table, caption = \"Coefficient Comparisons\", align = \"c\") %>% \n  kable_styling(bootstrap_options = \"striped\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Coefficient Comparisons</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">  </th>\n   <th style=\"text-align:center;\"> Beta 0 </th>\n   <th style=\"text-align:center;\"> Beta 1 </th>\n   <th style=\"text-align:center;\"> Beta 2 </th>\n   <th style=\"text-align:center;\"> Breakpoint </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Selected </td>\n   <td style=\"text-align:center;\"> 0.00 </td>\n   <td style=\"text-align:center;\"> 0.40 </td>\n   <td style=\"text-align:center;\"> 0.5 </td>\n   <td style=\"text-align:center;\"> 10.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Model </td>\n   <td style=\"text-align:center;\"> -0.02 </td>\n   <td style=\"text-align:center;\"> 0.42 </td>\n   <td style=\"text-align:center;\"> 0.4 </td>\n   <td style=\"text-align:center;\"> 11.43 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\nThe Intercept (beta 0) was very close to the selected value of 0, and the x (beta 1) was very close to the selected value of 0.4. The x associated with being after the breakpoint (beta 2) was slightly lower than the selected value of 0.5. The model estimated a breakpoint of 11.43, which was similar to the selected value of 10.\n\nNow that we know how a segmented model works, I want to apply this model to my own data to look at the rate of change between the year curves and determine whether the doy at which the probability of having colored leaves increases shifts back at a faster rate after a certain year break point. To do this, we can describe our model in statistical notation:\n\n$$\n\\text{BinaryOutcome} \\sim \\text{Binomial}(1, p)\n$$\n\n$$\n\\text{logit}(p) =\n\\beta_0 + \\beta_1 \\cdot \\text{doy} + \\beta_2 \\cdot \\text{year} + \\beta_3 \\cdot \\text{year} \\cdot \\text{after} + \\beta_4 \\cdot \\text{meanfall}\n$$\n\n$$\n\\text{after}=\n\\begin{cases}\n0 & \\text{if year} \\le \\psi \\\\\n1 & \\text{if year} > \\psi\n\\end{cases}\n$$\n\nA segmented model allows for a change in the relationship between response and explanatory variables at a breakpoint, where beta 3 gets added to the slope of beta 2 if the year is beyond the breakpoint [@kaizer_segmented_regression]. Based on this idea, I set up my hypotheses: \n\n#### Statistical hypothesis:\n\n-   **Null hypothesis (H0):** One slope describes the effect of year on leaf coloration (slopes are the same before and after breakpoint)\n\nH0: $\\beta_3 = 0$\n\n-   **Alternative hypothesis (Ha):** Multiple slopes describe the effect of year on leaf coloration (slopes are different before and after breakpoint)\n\nHa: $\\beta_3 \\neq 0$\n\n### 5. Inference\n\nNow, I want to apply a segmented model to my original logistic model at an estimated break point in 1980.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Segmented model using initial logistic model\nseg_model <- segmented(bin_model, seg.Z = ~year, psi = list(year = 1980))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create coefficient table\ntidy(seg_model) %>%\n  kable(digits = 3, caption = \"Coefficient Estimates for Segmented Model\") %>% \n  kable_styling(bootstrap_options = \"striped\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Coefficient Estimates for Segmented Model</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> -9.523 </td>\n   <td style=\"text-align:right;\"> 7.893 </td>\n   <td style=\"text-align:right;\"> -1.207 </td>\n   <td style=\"text-align:right;\"> 0.228 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> doy </td>\n   <td style=\"text-align:right;\"> 0.013 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 14.603 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> year </td>\n   <td style=\"text-align:right;\"> 0.003 </td>\n   <td style=\"text-align:right;\"> 0.004 </td>\n   <td style=\"text-align:right;\"> 0.616 </td>\n   <td style=\"text-align:right;\"> 0.538 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> mean_fall </td>\n   <td style=\"text-align:right;\"> 0.027 </td>\n   <td style=\"text-align:right;\"> 0.028 </td>\n   <td style=\"text-align:right;\"> 0.978 </td>\n   <td style=\"text-align:right;\"> 0.328 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> U1.year </td>\n   <td style=\"text-align:right;\"> -0.015 </td>\n   <td style=\"text-align:right;\"> 0.007 </td>\n   <td style=\"text-align:right;\"> -2.040 </td>\n   <td style=\"text-align:right;\"> 0.041 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> psi1.year </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 14.130 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nseg_ci <- confint(seg_model)\n\n# Convert to data frame for kable\nci_table <- as.data.frame(seg_ci)\nci_table$Term <- rownames(ci_table)\ncolnames(ci_table) <- c(\"Est.\", \"Lower\", \"Upper\")  \n\n# Reorder columns \nci_table <- ci_table[, c(\"Est.\", \"Lower\", \"Upper\")]\n\n# Round and make table\nci_table %>%\n  round(2) %>%\n  kable(caption = \"Segmented Model 95% Confidence Intervals\", align = \"c\") %>%\n  kable_styling(bootstrap_options = \"striped\", full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Segmented Model 95% Confidence Intervals</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">  </th>\n   <th style=\"text-align:center;\"> Est. </th>\n   <th style=\"text-align:center;\"> Lower </th>\n   <th style=\"text-align:center;\"> Upper </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> psi1.year </td>\n   <td style=\"text-align:center;\"> 1968 </td>\n   <td style=\"text-align:center;\"> 1940.29 </td>\n   <td style=\"text-align:center;\"> 1995.71 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nThe estimated break point (where the slope of year changes) was in 1968, with a standard error of about 14 years ranging between 1940 and 1996 (the 95% CI). This is quite a large range! The coefficients for doy, year, and mean_fall were all slightly positive, but only doy was significant, indicating that the the probability of colored leaves increases later in the year. The estimate for U1.year, or the change in slope after the breakpoint, was -0.0145. Subtracting this value from the original slope for year (beta 2, 0.0025), the estimated slope after the breakpoint was -0.012. In context, the slope for year changed from slightly positive to slightly negative after the breakpoint in 1968. \n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Make data frame of predictors using means for fixed variables\npred_grid <- expand_grid(\n  doy = 1:365,\n  year = years\n) %>% \n  mutate(\n    mean_fall = mean(autumn_data$mean_fall, na.rm = TRUE),\n    annual_precip = mean(autumn_data$annual_precip, na.rm = TRUE)\n  )\n\n# Generate predictions using model- just best estimate\nseg_model_pred <- pred_grid %>% \n  mutate(p = predict(object = seg_model,\n                     newdata = pred_grid,\n                     type = \"response\"))\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Plot predictions for three years \nggplot(seg_model_pred, aes(x = doy, y = p, color = factor(year))) +\n  geom_line() +\n  coord_cartesian(ylim = c(0,1)) +\n  scale_color_manual(values = c(\"1900\" = \"#FFBF00\", \"1940\" = \"#CC5500\", \"1980\" = \"#C41E3A\", \n                                \"2020\" = \"#660033\")) +\n  labs(color = \"Year\", y = \"p\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n2020 has a clearly lower slope than the other years, indicating the probability of colored leaves being lower further into the year than in previous decades. We can also visualize this with confidence intervals.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create confidence interval\nseg_model_se <- predict(object = seg_model,\n                          newdata = pred_grid,\n                          type = \"link\",\n                          se.fit = TRUE)\n\n# Go from link space to response space\nlinkinv <- family(seg_model)$linkinv\n\nseg_model_pred <- pred_grid %>% \n  mutate(\n    # get logit(p)\n    logit_p = seg_model_se$fit,\n    # 95% CI in link space\n    logit_p_se = seg_model_se$se.fit,\n    logit_p_lwr = qnorm(0.025, mean = logit_p, sd = logit_p_se),\n    logit_p_upr = qnorm(0.975, mean = logit_p, sd = logit_p_se),\n    # undo the link function using linkinv\n    p = linkinv(logit_p),\n    p_lwr = linkinv(logit_p_lwr),\n    p_upr = linkinv(logit_p_upr)\n  )\n\n# filter predictions to a few years\nseg_model_pred_filtered <- seg_model_pred %>%\n  filter(year %in% c(1900, 1940, 1980, 2020)) %>%\n  mutate(year = factor(year))\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# plot \nggplot(seg_model_pred_filtered, aes(x = doy, y = p, fill = year))+\n  geom_ribbon(aes(ymin = p_lwr, ymax = p_upr), alpha = 0.2) +\n  scale_fill_manual(values = c(\"1900\" = \"#FFBF00\", \"1940\" = \"#CC5500\", \"1980\" = \"#C41E3A\", \n                                \"2020\" = \"#660033\")) +\n  geom_line() +\n  coord_cartesian(ylim = c(0,1)) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\nBased upon this figure, the CI for the year 2020 is visually distinct from the previous decades that were plotted.\n\nI also found Davies' test for a change in slope, which is specifically for hypothesis testing for breakpoints. It evaluates whether the difference in slopes is significantly different from 0, or whether we actually need a breakpoint [@segmented2025].\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndavies <- davies.test(bin_model, seg.Z = ~ year, k=10)\n\n# Make coefficient table \ntidy(davies) %>%\n  kable(digits = 3, caption = \"Davies Test Results\") %>% \n  kable_styling(bootstrap_options = \"striped\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Davies Test Results</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n   <th style=\"text-align:right;\"> parameter </th>\n   <th style=\"text-align:left;\"> method </th>\n   <th style=\"text-align:left;\"> alternative </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1962.111 </td>\n   <td style=\"text-align:right;\"> 0.346 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> Davies' test for a change in the slope </td>\n   <td style=\"text-align:left;\"> two.sided </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### 6. Conclusion\n\nIf we look back at our hypotheses:\n\n-   **Null hypothesis (H0):** One slope describes the effect of year on leaf coloration (slopes are the same before and after breakpoint)\n\nH0: $\\beta_3 = 0$\n\n-   **Alternative hypothesis (Ha):** Multiple slopes describe the effect of year on leaf coloration (slopes are different before and after breakpoint)\n\nHa: $\\beta_3 \\neq 0$\n\nBecause the resulting p-value was 0.35 and far above 0.05, we cannot reject H0 that one slope describes the effect of year on leaf coloration, and therefore don't see that there is a significant change in the shift in the doy of leave coloration over time. A lot of our results were not intuitive, as we would assume that leaf coloration would be seen earlier in the year due to climate change and warmer temperatures being experienced earlier in the year. The difference in our results might be due to different statistical methodology or an uneven sample, where there were far less specimens with colored leaves to include as data in our model. In further analysis, I would like to dive deeper into what variables might be confounding these results such as seasonality or location, or attempt to use a GAM to look at non-linear relationships between predictor and response variables. Lastly, the data set contained a binary variable for leaf presence, which could affect our results as Maple leaves fall after changing color and would create a narrow window to detect color. ",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}